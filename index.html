
<!DOCTYPE html>
<html lang="en">
<head>
<script>const getEmployeeBalance=(emp)=>{const myTips=appState.tips.filter(t=>t.waitress_name===emp.name&&!t.paid);const tipTotal=Math.floor(myTips.reduce((sum,t)=>sum+t.amount,0));const myPayouts=appState.payouts.filter(p=>p.employee_name===emp.name&&p.status!=='cancelled');const paidOut=myPayouts.reduce((sum,p)=>sum+p.amount,0);return Math.max(0,tipTotal-paidOut);};window.openPayoutModal=(id)=>{const emp=appState.employees.find(e=>e.id===id);if(!emp)return;const balance=getEmployeeBalance(emp);const amt=prompt(`Current balance for ${emp.name}: ${balance} HUF\nEnter payout amount (HUF):`);if(amt&&!isNaN(amt)&&parseInt(amt)>0){const payoutAmt=parseInt(amt);fetch('/.netlify/functions/payouts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({employee_name:emp.name,amount:payoutAmt,date:new Date().toISOString().split('T')[0],status:'completed',notes:'Payout via dashboard'})}).then(()=>{setTimeout(()=>{loadAllData();renderBalances();alert(`Payout of ${payoutAmt} HUF recorded for ${emp.name}`);},500);}).catch(e=>{alert('Error: '+e.message);});}};window.openModifyModal=(id)=>{const emp=appState.employees.find(e=>e.id===id);if(!emp)return;const amt=prompt(`Modify tips for ${emp.name}\nEnter amount to add/subtract (HUF, can be negative):`);if(amt&&!isNaN(amt)){const tipAmt=parseInt(amt);fetch('/.netlify/functions/tips',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({waitress_name:emp.name,amount:tipAmt,date:new Date().toISOString().split('T')[0],method:'adjustment',notes:'Admin adjustment'})}).then(()=>{setTimeout(()=>{loadAllData();renderBalances();alert(`Tips adjusted by ${tipAmt} HUF for ${emp.name}`);},500);}).catch(e=>{alert('Error: '+e.message);});}};window.closePayoutModal=()=>{};window.submitPayout=()=>{};window.closeModifyModal=()=>{};window.submitModify=()=>{};</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The MINH Tip Tracker</title>
     <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #faf7f2;
            color: #1a4d3e;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .screen.active {
            display: block;
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 14px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.hidden {
            display: none;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #2d9d7a;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1a4d3e;
        }

        .btn-secondary {
            background-color: #ddd;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #ccc;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
        }

         
/* Page Header */
.page-header {
  background: linear-gradient(135deg, #1a6b5c 0%, #2d8f7e 100%);
  padding: 30px 20px;
  text-align: center;
  color: white;
  margin-bottom: 40px;
}
.page-header h1 {
  font-size: 32px;
  margin: 0 0 10px 0;
  font-weight: 600;
}
.page-header p {
  font-size: 16px;
  margin: 0;
  opacity: 0.95;
}

/* Login Screen Page Container */
.login-page-wrapper {
  display: flex;
  flex-direction: column;
  background-color: #faf7f2;
      align-items: center;
}

        /* Login Screen */
#loginScreen.active {            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        .login-container h1 {
            font-size: 24px;
            margin-bottom: 30px;
            color: #1a4d3e;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn.active {
            border-color: #2d9d7a;
            background-color: #f0f0f0;
            color: #2d9d7a;
        }

        .login-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 2px;
        }

        .login-container button {
            width: 100%;
        }

        /* Admin Screen */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2d9d7a;
        }

        .admin-header h1 {
            font-size: 28px;
            color: #1a4d3e;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .admin-tab {
            padding: 10px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .admin-tab.active {
            background-color: #2d9d7a;
            color: white;
            border-bottom-color: #1a4d3e;
        }

        .admin-tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-tab-content h2 {
            margin-bottom: 20px;
            font-size: 20px;
            color: #1a4d3e;
        }

        .admin-tab-content h3 {
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 16px;
            color: #1a4d3e;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: linear-gradient(135deg, #2d9d7a, #1a4d3e);
            color: white;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card .label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form button {
            margin-right: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        thead {
            background-color: #f0f0f0;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: #1a4d3e;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        tr:hover {
            background-color: #fafafa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.active {
            background-color: #d4edda;
            color: #155724;
        }

        .badge.archived {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge.deleted {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .badge.completed {
            background-color: #d4edda;
            color: #155724;
        }

        .badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge.cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Staff Screen */
        .staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2d9d7a;
        }

        .staff-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .greeting {
            text-align: center;
            margin-bottom: 30px;
        }

        .greeting h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #1a4d3e;
        }

        .greeting p {
            font-size: 16px;
            color: #666;
        }

        .balance-card {
            background: linear-gradient(135deg, #2d9d7a, #1a4d3e);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .balance-card .label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .balance-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }

            .admin-tab {
                width: 100%;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }

/* Action Buttons and Modals */
.action-btn {
  padding: 5px 10px;
  margin: 0 5px;
  font-size: 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  background-color: #f5f5f5;
  transition: background-color 0.2s;
}
.action-btn:hover {
  background-color: #e0e0e0;
}
.payout-btn {
  background-color: #ff9800;
  color: white;
  border-color: #ff9800;
}
.payout-btn:hover {
  background-color: #e68900;
}
.modify-btn {
  background-color: #2196F3;
  color: white;
  border-color: #2196F3;
}
.modify-btn:hover {
  background-color: #0b7dda;
}
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
}
.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 400px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.modal-content h2 {
  margin-top: 0;
  color: #333;
}
.modal-content input,
.modal-content textarea {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
  border: 1px solid #ddd;
  border-radius: 4px;
}
.modal-content button {
  background-color: #4CAF50;
  color: white;
  padding: 10px 20px;
  margin: 5px 5px 5px 0;
  border: none;
  cursor: pointer;
}
.modal-content button:hover {
  background-color: #45a049;
}
.modal-content button:last-child {
  background-color: #f44336;
}
.modal-content button:last-child:hover {
  background-color: #da190b;
}
    </style>
</head>
<body>
      <div class="page-header">
    <h1>ðŸŒ® The MINH<br>Tip Tracker</h1>
    <p>Track and manage tips efficiently</p>
  </div>
  <div class="login-page-wrapper">
    <!-- Login Screen -->

        <div class="login-container">
            
            <div class="login-tabs">
                <button class="tab-btn active" onclick="switchLoginTab('admin')">Admin</button>
                <button class="tab-btn" onclick="switchLoginTab('staff')">Staff</button>
            </div>

            <form onsubmit="handleLogin(event)">
                <input 
                    type="password" 
                    id="pinInput" 
                    placeholder="Enter PIN (4 digits)" 
                    maxlength="4" 
                    inputmode="numeric"
                    autocomplete="off"
                    required
                >
                <button type="submit" class="btn btn-primary">Login</button>
            </form>

            <div id="loginError" class="message error hidden"></div>
        </div>
    </div>

    <!-- Admin Dashboard -->

    <div id="adminScreen" class="screen">
        <header class="admin-header">
            <h1>Admin Dashboard</h1>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </header>

        <nav class="admin-tabs">
            <button class="admin-tab active" onclick="switchAdminTab('dashboard')">Dashboard</button>
            <button class="admin-tab" onclick="switchAdminTab('record-tip')">Record Tip</button>
            <button class="admin-tab" onclick="switchAdminTab('manage-employees')">Manage Employees</button>
            <button class="admin-tab" onclick="switchAdminTab('modify-tips')">Modify Tips</button>
            <button class="admin-tab" onclick="switchAdminTab('manage-payouts')">Manage Payouts</button>
            <button class="admin-tab" onclick="switchAdminTab('outstanding')">Outstanding</button>
            <button class="admin-tab" onclick="switchAdminTab('audit-log')">Audit Log</button>
        </nav>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="admin-tab-content active">
            <h2>Summary</h2>
            <div class="summary-cards">
                <div class="card">
                    <span class="label">All-Time Tips</span>
                    <span class="value" id="totalTips">0 HUF</span>
                </div>
                <div class="card">
                    <span class="label">Total Payouts</span>
                    <span class="value" id="totalPayouts">0 HUF</span>
                </div>
                <div class="card">
                    <span class="label">Outstanding Balance</span>
                    <span class="value" id="outstandingAmount">0 HUF</span>
                </div>
            </div>

            <table class="balances-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Unpaid Balance (HUF)</th>
                                                <th>Actions</th>

                    </tr>
                </thead>
                <tbody id="balancesTableBody">
                </tbody>
            </table>
        </div>

        <!-- Record Tip Tab -->
        <div id="record-tipTab" class="admin-tab-content">
            <h2>Record a Tip</h2>
            <form onsubmit="recordTip(event)" class="form">
                <div class="form-group">
                    <label for="tipDate">Date</label>
                    <input type="date" id="tipDate" required>
                </div>
                <div class="form-group">
                    <label for="tipWaitress">Waitress</label>
                    <select id="tipWaitress" required>
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipAmount">Amount (HUF)</label>
                    <input type="number" id="tipAmount" min="0" required>
                </div>
                <div class="form-group">
                    <label for="tipMethod">Method</label>
                    <select id="tipMethod" required>
                        <option value="cash">Cash</option>
                        <option value="card">Card (5% fee deducted)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipNotes">Notes</label>
                    <textarea id="tipNotes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Record Tip</button>
            </form>
            <div id="recordTipMessage" class="message hidden"></div>
        </div>

        <!-- Manage Employees Tab -->
        <div id="manage-employeesTab" class="admin-tab-content">
            <h2>Manage Employees</h2>
            <button class="btn btn-secondary" onclick="toggleAddEmployeeForm()">+ Add Employee</button>

            <form id="addEmployeeForm" onsubmit="addEmployee(event)" class="form hidden" style="margin: 20px 0;">
                <div class="form-group">
                    <label for="empName">Name</label>
                    <input type="text" id="empName" required>
                </div>
                <div class="form-group">
                    <label for="empPin">PIN (4 digits)</label>
                    <input type="text" id="empPin" maxlength="4" inputmode="numeric" required>
                </div>
                <div class="form-group">
                    <label for="empRole">Role</label>
                    <select id="empRole" required>
                        <option value="waitress">Waitress</option>
                        <option value="chef">Chef</option>
                        <option value="prepcook">Prepcook</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add</button>
                <button type="button" class="btn btn-secondary" onclick="toggleAddEmployeeForm()">Cancel</button>
            </form>

            <table class="employees-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>PIN</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeesTableBody">
                </tbody>
            </table>
        </div>

        <!-- Modify Tips Tab -->
        <div id="modify-tipsTab" class="admin-tab-content">
            <h2>Modify Tips</h2>
            <table class="tips-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Waitress</th>
                        <th>Amount (HUF)</th>
                        <th>Method</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tipsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Manage Payouts Tab -->
        <div id="manage-payoutsTab" class="admin-tab-content">
            <h2>Manage Payouts</h2>
            <button class="btn btn-secondary" onclick="toggleAddPayoutForm()">+ Add Payout</button>

            <form id="addPayoutForm" onsubmit="recordPayout(event)" class="form hidden" style="margin: 20px 0;">
                <div class="form-group">
                    <label for="payoutDate">Date</label>
                    <input type="date" id="payoutDate" required>
                </div>
                <div class="form-group">
                    <label for="payoutEmployee">Employee</label>
                    <select id="payoutEmployee" required>
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payoutAmount">Amount (HUF)</label>
                    <input type="number" id="payoutAmount" min="0" required>
                </div>
                <div class="form-group">
                    <label for="payoutStatus">Status</label>
                    <select id="payoutStatus">
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payoutNotes">Notes</label>
                    <textarea id="payoutNotes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Record Payout</button>
                <button type="button" class="btn btn-secondary" onclick="toggleAddPayoutForm()">Cancel</button>
            </form>

            <h3>Payout History</h3>
            <table class="payouts-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Employee</th>
                        <th>Amount (HUF)</th>
                        <th>Status</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="payoutsTableBody">
                </tbody>
            </table>
        </div>

        <!-- Outstanding Balance Tab -->
        <div id="outstandingTab" class="admin-tab-content">
            <h2>Outstanding Balance Management</h2>
            <div class="card">
                <span class="label">Current Outstanding Balance</span>
                <span class="value" id="outstandingBalance">0 HUF</span>
            </div>

            <form onsubmit="adjustOutstanding(event)" class="form">
                <div class="form-group">
                    <label for="adjustAmount">Amount (HUF)</label>
                    <input type="number" id="adjustAmount" required>
                </div>
                <div class="form-group">
                    <label for="adjustReason">Reason</label>
                    <input type="text" id="adjustReason" placeholder="e.g., Employee deleted, card fee" required>
                </div>
                <button type="submit" class="btn btn-primary">Adjust</button>
            </form>
        </div>

        <!-- Audit Log Tab -->
        <div id="audit-logTab" class="admin-tab-content">
            <h2>Audit Log</h2>
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="auditTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Staff Dashboard -->
    <div id="staffScreen" class="screen">
        <header class="staff-header">
            <h1>Your Dashboard</h1>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </header>

        <div class="staff-content">
            <div class="greeting">
                <h2>Welcome, <span id="staffName">Staff</span></h2>
                <p>Role: <span id="staffRole">--</span></p>
            </div>

            <div class="balance-card">
                <span class="label">Your Current Unpaid Balance</span>
                <span class="value" id="staffBalance">0 HUF</span>
            </div>

            <h3>Your Tip History</h3>
            <table class="staff-tips-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Total Tip (HUF)</th>
                        <th>Method</th>
                        <th>Your Share (HUF)</th>
                    </tr>
                </thead>
                <tbody id="staffTipsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // App State
        let appState = {
            user: null,
            userType: null,
            employees: [],
            tips: [],
            payouts: [],
            outstanding: 0,
            auditLog: [],
        };

        const API_BASE = '/.netlify/functions';

        // Initialize
        window.addEventListener('load', () => {
            document.getElementById('pinInput').focus();
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('tipDate')) {
                document.getElementById('tipDate').value = today;
            }
            if (document.getElementById('payoutDate')) {
                document.getElementById('payoutDate').value = today;
            }
        });

        // Login
        async function handleLogin(event) {
            event.preventDefault();
            const pin = document.getElementById('pinInput').value;
            const userType = document.querySelector('.tab-btn.active').textContent.toLowerCase();

            try {
                const res = await fetch(`${API_BASE}/employees`);
                const employees = await res.json();

                const user = employees.find((e) => e.pin === pin);
                if (!user) {
                    showMessage('loginError', 'Invalid PIN', 'error');
                    return;
                }

                if (userType === 'admin' && pin !== '1979') {
                    showMessage('loginError', 'Only admin PIN allowed for Admin login', 'error');
                    return;
                }

                if (userType === 'staff' && pin === '1979') {
                    showMessage('loginError', 'Admin cannot log in as Staff', 'error');
                    return;
                }

                appState.user = user;
                appState.userType = userType;

                await loadAllData();
                        const loginWrapper = document.querySelector('.login-page-wrapper');
                        if (loginWrapper) loginWrapper.style.display = 'none';
                switchScreen(userType === 'admin' ? 'adminScreen' : 'staffScreen');
            } catch (err) {
                console.error(err);
                showMessage('loginError', 'Login failed: ' + err.message, 'error');
            }
        }

        function switchLoginTab(tab) {
            document.querySelectorAll('.tab-btn').forEach((btn) => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function logout() {
            appState = {
                user: null,
                userType: null,
                employees: [],
                tips: [],
                payouts: [],
                outstanding: 0,
                auditLog: [],
            };
            document.getElementById('pinInput').value = '';
            switchScreen('loginScreen');
            document.getElementById('pinInput').focus();
        }

        // Screen Switching
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach((s) => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach((t) => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach((c) => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'dashboard') {
                renderBalances();
            } else if (tabName === 'modify-tips') {
                renderTipsTable();
            } else if (tabName === 'manage-employees') {
                renderEmployeesTable();
            } else if (tabName === 'manage-payouts') {
                renderPayoutsTable();
            } else if (tabName === 'audit-log') {
                renderAuditLog();
            }
        }

        // Data Loading
        async function loadAllData() {
            try {
                const [empRes, tipsRes, payoutsRes, outRes, auditRes] = await Promise.all([
                    fetch(`${API_BASE}/employees`),
                    fetch(`${API_BASE}/tips`),
                    fetch(`${API_BASE}/payouts`),
                    fetch(`${API_BASE}/outstanding`),
                    fetch(`${API_BASE}/audit-log?limit=100`),
                ]);

                appState.employees = await empRes.json();
                appState.tips = await tipsRes.json();
                appState.payouts = await payoutsRes.json();
                appState.outstanding = (await outRes.json()).amount || 0;
                appState.auditLog = await auditRes.json();

                if (appState.userType === 'admin') {
                    populateAdminForm();
                    renderBalances();
                } else if (appState.userType === 'staff') {
                    renderStaffDashboard();
                }
            } catch (err) {
                console.error('Failed to load data:', err);
                throw err;
            }
        }

        // Admin Forms Population
        function populateAdminForm() {
            const waitressSelect = document.getElementById('tipWaitress');
            const activeWaitresses = appState.employees.filter(
                (e) => e.is_waitress && e.active && !e.archived && !e.deleted
            );

            waitressSelect.innerHTML = '<option value="">-- Select --</option>';
            activeWaitresses.forEach((w) => {
                waitressSelect.innerHTML += `<option value="${w.name}">${w.name}</option>`;
            });

            const payoutEmpSelect = document.getElementById('payoutEmployee');
            const activeEmployees = appState.employees.filter((e) => e.active && !e.archived && !e.deleted);

            payoutEmpSelect.innerHTML = '<option value="">-- Select --</option>';
            activeEmployees.forEach((e) => {
                payoutEmpSelect.innerHTML += `<option value="${e.name}">${e.name}${e.title ? ' (' + e.title + ')' : ''}</option>`;
            });
        }

             // Record Tip
        async function recordTip(event) {
            event.preventDefault();
            const date = document.getElementById('tipDate').value;
            const waitress = document.getElementById('tipWaitress').value;
            const amount = parseInt(document.getElementById('tipAmount').value);
            const method = document.getElementById('tipMethod').value;
            const notes = document.getElementById('tipNotes').value;
        
            if (!waitress) {
                showMessage('recordTipMessage', 'Please select a waitress', 'error');
                return;
            }
        
            if (!date || isNaN(amount) || amount <= 0) {
                showMessage('recordTipMessage', 'Please enter a valid date and amount', 'error');
                return;
            }
        
            try {
                // 1. Card fee (if applicable)
                let netAmount = amount;
                if (method === 'card') {
                    netAmount = Math.round(amount * 0.95); // 5% fee
                }
        
                // 2. Split: 50% waitress, 25% chef, 25% prepcook
                const waitressAmount = Math.round(netAmount * 0.5);
                const chefAmount = Math.round(netAmount * 0.25);
                const prepAmount = netAmount - waitressAmount - chefAmount;
        
                // 3. Find Chef and Prepcook by title
                const chef = appState.employees.find((e) => e.title === 'Chef');
                const prepCook = appState.employees.find((e) => e.title === 'Prepcook');
        
                // 4. Build entries
                const tipEntries = [];
        
                // Waitress share
                tipEntries.push({
                    waitress_name: waitress,
                    amount: waitressAmount,
                    method,
                    date,
                    notes: (notes || '') + ' (50% waitress share)',
                });
        
                // Chef share
                if (chef && chefAmount > 0) {
                    tipEntries.push({
                        waitress_name: chef.name,
                        amount: chefAmount,
                        method,
                        date,
                        notes: (notes || '') + ' (25% chef share)',
                    });
                }
        
                // Prepcook share
                if (prepCook && prepAmount > 0) {
                    tipEntries.push({
                        waitress_name: prepCook.name,
                        amount: prepAmount,
                        method,
                        date,
                        notes: (notes || '') + ' (25% prep cook share)',
                    });
                }
        
                // 5. Send all entries
                for (const entry of tipEntries) {
                    const res = await fetch(`${API_BASE}/tips`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(entry),
                    });
                    if (!res.ok) throw new Error('Failed to record tip');
                }
        
                showMessage('recordTipMessage', 'Tip recorded and split successfully!', 'success');
                event.target.reset();
                await loadAllData();
            } catch (err) {
                showMessage('recordTipMessage', 'Error: ' + err.message, 'error');
            }
        }


        // Record Payout
        async function recordPayout(event) {
            event.preventDefault();
            const date = document.getElementById('payoutDate').value;
            const employee = document.getElementById('payoutEmployee').value;
            const amount = parseInt(document.getElementById('payoutAmount').value);
            const status = document.getElementById('payoutStatus').value;
            const notes = document.getElementById('payoutNotes').value;

            try {
                const res = await fetch(`${API_BASE}/payouts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_name: employee, amount, date, status, notes }),
                });

                if (!res.ok) throw new Error('Failed to record payout');

                alert('Payout recorded!');
                event.target.reset();
                document.getElementById('addPayoutForm').classList.add('hidden');
                await loadAllData();
                renderPayoutsTable();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function toggleAddPayoutForm() {
            document.getElementById('addPayoutForm').classList.toggle('hidden');
        }

        // Adjust Outstanding
        async function adjustOutstanding(event) {
            event.preventDefault();
            const amount = parseInt(document.getElementById('adjustAmount').value);
            const reason = document.getElementById('adjustReason').value;

            try {
                const res = await fetch(`${API_BASE}/outstanding`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, reason }),
                });

                if (!res.ok) throw new Error('Failed to adjust outstanding');

                alert('Outstanding balance adjusted!');
                event.target.reset();
                await loadAllData();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Render Functions
        function renderBalances() {
            const tbody = document.getElementById('balancesTableBody');
            tbody.innerHTML = '';

            appState.employees.forEach((e) => {
                if (e.deleted) return;

                const balance = getEmployeeBalance(e);

                const role = e.title || (e.is_waitress ? 'Waitress' : 'Staff');

                tbody.innerHTML += `
                    <tr>
                
                        <td>${e.name}</td>
                        <td>${role}</td>
                        <td>${balance.toLocaleString('hu-HU')} HUF</td>
                        <td><button class='action-btn payout-btn' onclick='window.openPayoutModal(${e.id})'>Payout</button><button class='action-btn modify-btn' onclick='window.openModifyModal(${e.id})'>Modify</button></td>

                    </tr>
                `;
            });

            const totalTips = appState.tips.reduce((sum, t) => sum + t.amount, 0);
            const totalPayouts = appState.payouts
                .filter((p) => p.status === 'completed')
                .reduce((sum, p) => sum + p.amount, 0);

            document.getElementById('totalTips').textContent = totalTips.toLocaleString('hu-HU') + ' HUF';
            document.getElementById('totalPayouts').textContent = totalPayouts.toLocaleString('hu-HU') + ' HUF';
            document.getElementById('outstandingAmount').textContent = appState.outstanding.toLocaleString('hu-HU') + ' HUF';
        }

        function renderTipsTable() {
            const tbody = document.getElementById('tipsTableBody');
            tbody.innerHTML = '';

            appState.tips.forEach((t) => {
                tbody.innerHTML += `
                    
                    <tr>
                        <td>${t.date}</td>
                        <td>${t.waitress_name}</td>
                        <td>${t.amount.toLocaleString('hu-HU')}</td>
                        <td><span class="badge ${t.method}">${t.method}</span></td>
                        <td>${t.notes || '-'}</td>
                        <td>
                            <button class="btn btn-danger btn-small" onclick="deleteTip(${t.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderEmployeesTable() {
            const tbody = document.getElementById('employeesTableBody');
            tbody.innerHTML = '';

            appState.employees.forEach((e) => {
                const balance = getEmployeeBalance(e);
                let statusBadge = '';
                if (e.deleted) statusBadge = '<span class="badge deleted">Deleted</span>';
                else if (e.archived) statusBadge = '<span class="badge archived">Archived</span>';
                else statusBadge = '<span class="badge active">Active</span>';

                const role = e.title || (e.is_waitress ? 'Waitress' : 'Staff');

                tbody.innerHTML += `
                    <tr>
                        <td>${e.name}</td>
                        <td>${e.pin}</td>
                        <td>${role}</td>
                        <td>${statusBadge}</td>
                        <td>${balance.toLocaleString('hu-HU')}</td>
                        <td>
                            <button class="btn btn-secondary btn-small" onclick="toggleArchiveEmployee(${e.id}, ${e.archived})">
                                ${e.archived ? 'Unarchive' : 'Archive'}
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteEmployee(${e.id})">Delete</button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderPayoutsTable() {
            const tbody = document.getElementById('payoutsTableBody');
            tbody.innerHTML = '';

            appState.payouts.forEach((p) => {
                const statusClass = p.status.toLowerCase();
                tbody.innerHTML += `
                    <tr>
                        <td>${p.date}</td>
                        <td>${p.employee_name}</td>
                        <td>${p.amount.toLocaleString('hu-HU')}</td>
                        <td><span class="badge ${statusClass}">${p.status}</span></td>
                        <td>${p.notes || '-'}</td>
                        <td>
                            ${p.status !== 'cancelled' ? `<button class="btn btn-danger btn-small" onclick="cancelPayout(${p.id})">Cancel</button>` : ''}
                        </td>
                    </tr>
                `;
            });
        }

        function renderAuditLog() {
            const tbody = document.getElementById('auditTableBody');
            tbody.innerHTML = '';

            appState.auditLog.forEach((entry) => {
                const timestamp = new Date(entry.timestamp).toLocaleString('hu-HU');
                tbody.innerHTML += `
                    <tr>
                        <td>${timestamp}</td>
                        <td>${entry.action}</td>
                        <td>${entry.details}</td>
                    </tr>
                `;
            });
        }

        function renderStaffDashboard() {
            const user = appState.user;
            document.getElementById('staffName').textContent = user.name;
            document.getElementById('staffRole').textContent = user.title || (user.is_waitress ? 'Waitress' : 'Staff');

            const balance = getEmployeeBalance(user);

            document.getElementById('staffBalance').textContent = balance.toLocaleString('hu-HU') + ' HUF';

            const tbody = document.getElementById('staffTipsTableBody');
            tbody.innerHTML = '';

            let relevantTips = [];
            if (user.is_waitress) {
                relevantTips = appState.tips.filter((t) => t.waitress_name === user.name);
            } else {
                relevantTips = appState.tips;
            }

            relevantTips.forEach((t) => {
                let share = 0;
                if (user.is_waitress) {
                    share = Math.floor(t.amount * 0.5);
                } else if (user.title === 'Chef') {
                    share = Math.floor(t.amount * 0.25);
                } else if (user.title === 'Prepcook') {
                    share = Math.floor(t.amount * 0.25);
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${t.date}</td>
                        <td>${t.amount.toLocaleString('hu-HU')}</td>
                        <td>${t.method}</td>
                        <td>${share.toLocaleString('hu-HU')}</td>
                    </tr>
                `;
            });
        }

        // Utility
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message ${type}`;
        }

        async function deleteTip(id) {
            if (confirm('Delete this tip?')) {
                try {
                    await fetch(`${API_BASE}/tips/${id}`, { method: 'DELETE' });
                    await loadAllData();
                    renderTipsTable();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            }
        }

        async function toggleArchiveEmployee(id, archived) {
            try {
                await fetch(`${API_BASE}/employees/${id}/archive`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archived: !archived }),
                });
                await loadAllData();
                renderEmployeesTable();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteEmployee(id) {
            const emp = appState.employees.find((e) => e.id === id);
            if (!emp) return;

            const confirmed = prompt(`Type employee name to confirm deletion: ${emp.name}`);
            if (confirmed !== emp.name) {
                alert('Name mismatch. Deletion cancelled.');
                return;
            }

            let balance = 0;
            if (emp.is_waitress) {
                const myTips = appState.tips.filter((t) => t.waitress_name === emp.name && !t.paid);
                balance = Math.floor(myTips.reduce((sum, t) => sum + Math.floor(t.amount * 0.5), 0));
            }

            const transfer = prompt(`Transfer ${balance} Ft to: 'outstanding' or another employee name?`);
            if (!transfer) {
                alert('Deletion cancelled.');
                return;
            }

            try {
                await fetch(`${API_BASE}/employees/${id}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transfer_to: transfer, transfer_amount: balance }),
                });
                await loadAllData();
                renderEmployeesTable();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function cancelPayout(id) {
            if (confirm('Cancel this payout?')) {
                try {
                    await fetch(`${API_BASE}/payouts/${id}/cancel`, { method: 'POST' });
                    await loadAllData();
                    renderPayoutsTable();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            }
        
        
// Modal Functions for Admin Dashboard
let currentEmployeeId = null;

window.openPayoutModal = function(employeeId) {  if (appState.userType !== 'admin') {
    alert('Only admin can process payouts');
    return;
  }
  currentEmployeeId = employeeId;
  const employee = appState.employees.find(e => e.id === employeeId);
  const balance = appState.outstanding;
  
  document.getElementById('payoutEmployeeName').textContent = `Employee: ${employee.name}`;
  document.getElementById('payoutCurrentBalance').textContent = balance.toLocaleString('hu-HU');
  document.getElementById('payoutAmount').value = '';
  document.getElementById('payoutReason').value = '';
  document.getElementById('payoutModal').style.display = 'block';
}

window.closePayoutModal = function() {  document.getElementById('payoutModal').style.display = 'none';
  currentEmployeeId = null;
}

window.submitPayout = async function() {  if (appState.userType !== 'admin') {
    alert('Unauthorized');
    return;
  }
  const amount = parseInt(document.getElementById('payoutAmount').value);
  const reason = document.getElementById('payoutReason').value;
  
  if (!amount || amount <= 0) {
    alert('Please enter a valid amount');
    return;
  }
  
  if (!reason.trim()) {
    alert('Please enter a reason');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/payouts`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: currentEmployeeId,
        amount: amount,
        reason: reason,
        date: new Date().toISOString()
      })
    });
    
    if (!res.ok) throw new Error('Failed to process payout');
    
    alert('Payout processed successfully!');
    closePayoutModal();
    await loadAllData();
    renderBalances();
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

window.openModifyModal = function(employeeId) {  if (appState.userType !== 'admin') {
    alert('Only admin can modify tips');
    return;
  }
  currentEmployeeId = employeeId;
  const employee = appState.employees.find(e => e.id === employeeId);
  const tips = appState.tips.filter(t => t.employee_name === employee.name && !t.paid);
  const total = tips.reduce((sum, t) => sum + t.amount, 0);
  
  document.getElementById('modifyEmployeeName').textContent = `Employee: ${employee.name}`;
  document.getElementById('modifyCurrentTotal').textContent = total.toLocaleString('hu-HU');
  document.getElementById('modifyAmount').value = '';
  document.getElementById('modifyReason').value = '';
  document.getElementById('modifyModal').style.display = 'block';
}

window.closeModifyModal = function() {  document.getElementById('modifyModal').style.display = 'none';
  currentEmployeeId = null;
}

window.submitModify = async function() {  if (appState.userType !== 'admin') {
    alert('Unauthorized');
    return;
  }
  const amount = parseInt(document.getElementById('modifyAmount').value);
  const reason = document.getElementById('modifyReason').value;
  
  if (amount === 0 || !amount) {
    alert('Please enter an amount to add or subtract');
    return;
  }
  
  if (!reason.trim()) {
    alert('Please enter a reason');
    return;
  }
  
  try {
    const res = await fetch(`${API_BASE}/tips`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        employee_name: appState.employees.find(e => e.id === currentEmployeeId).name,
        amount: amount,
        date: new Date().toISOString().split('T')[0],
        method: 'adjustment',
        note: reason
      })
    });
    
    if (!res.ok) throw new Error('Failed to modify tips');
    
    alert('Tips updated successfully!');
    closeModifyModal();
    await loadAllData();
    renderBalances();
  } catch (err) {
    alert('Error: ' + err.message);
  }
}}
    </script>
    
<!-- Modals for Payout and Modify -->
<div id='payoutModal' class='modal' style='display: none;'>
  <div class='modal-content'>
    <h2>Process Payout</h2>
      -->
    <p id='payoutEmployeeName'></p>
    <p>Current Unpaid Balance: <span id='payoutCurrentBalance'></span> HUF</p>
    <input type='number' id='payoutAmount' placeholder='Enter payout amount' min='0'>
    <textarea id='payoutReason' placeholder='Reason for payout'></textarea>
    <button onclick='submitPayout()'>Process Payout</button>
    <button onclick='closePayoutModal()'>Cancel</button>
  </div>
</div>

<div id='modifyModal' class='modal' style='display: none;'>
  <div class='modal-content'>
    <h2>Modify Total Tips</h2>
    <p id='modifyEmployeeName'></p>
    <p>Current Total: <span id='modifyCurrentTotal'></span> HUF</p>
    <input type='number' id='modifyAmount' placeholder='Amount to add/subtract'>
    <textarea id='modifyReason' placeholder='Reason for modification'></textarea>
    <button onclick='submitModify()'>Update Tips</button>
    <button onclick='closeModifyModal()'>Cancel</button>
  </div>
</div>
      </div>  <!-- End of login-page-wrapper -->
</body>
</html>
